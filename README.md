qm-wechat
===========

千米微信第三方平台应用

http://wechat.qianmi.com

## TOKEN
- component_access_token
  第三方平台令牌，主要用于获取预授权码pre_auth_code  ***【有效期2小时，不能刷新】***

- authorizer_access_token  
  授权方公众号token，用于代替公众号访问API ***【有效期2小时，可以刷新】***

- authorizer_refresh_token
  用于刷新授权方令牌，避免重新授权。
  请妥善保存，一旦丢失，只能让用户重新授权，才能再次拿到新的刷新令牌

## 主要步骤
- 1、获取微信推送给第三方平台的component_verify_ticket（十分钟推送一次），获取后 ***缓存到redis***；

- 2、拿component_verify_ticket换取第三方平台component_access_token（有效期2小时），***缓存到redis***，
     不能刷新，每次从缓存获取时判断过期时间，提前重新获取；

- 3、拿component_access_token换取预授权码pre_auth_code。授权码的获取，需要在用户在
     第三方平台授权页中完成授权流程后，在回调URI中通过URL参数提供给第三方平台方（有效期十分钟）

- 4、使用pre_auth_code换取授权公众号的授权信息，并换取authorizer_access_token和
     authorizer_refresh_token（有效期2小时），***缓存到redis***，每次使用时检测token的有效期，到期后刷新；

- 5、使用authorizer_access_token访问公众号API

## 消息与菜单权限集
指公众号第三方平台方在获得该权限集后，可以获得被授权公众号的消息与菜单相关的权限。由于涉及到接收并回复粉丝消息，为了防止多方对话交叠而导致用户收到多条消息，故一个公众号至多只能授权给一个公众号第三方平台，即授权互斥。具体包括：

1) 接收和回复被动响应消息能力  
2) 客服消息接口  
3) 获取语音识别开关状态  
4) 设置语音识别开关  
5) 上传下载多媒体文件接口  
6) 自定义菜单的创建、查询和删除  
7) 自定义菜单点击事件接收  
8) 订阅/取消订阅事件推送  
## 用户管理权限集
指公众号第三方平台方在获得该权限集后，可以获得被授权公众号的用户管理权限。由于可供多方获取，故授权不互斥。具体包括：

1) 获取用户基本信息接口  
2) 获取用户列表接口  
3) 用户分组管理接口  
4) 用户备注名设置接口  
5) 设置用户地理位置的开关及上报方式  
6) 获取用户地理位置上报的开关状态及上报方式  
## 帐号管理权限集
该权限集主要进行公众帐号的帐号管理，包括获取和设置公众帐号信息，由于可供多方获取和设置，故授权不互斥。具体包括：

## 网页开发权限集
1) 生成带参数二维码接口  
2) 扫描带参数二维码的事件接收  
3) 获取公众帐号基础信息(头像昵称/帐号类型等,此接口暂为服务方独有)  
4）上传下载多媒体文件接口  

## 网页开发权限集
该权限集主要指公众号第三方平台可以代替公众帐号发起微信网页授权，并在授权后可以合法获得相关的授权信息，还包括可以代替公众号使用JS SDK。由于可供多方使用，故授权不互斥。具体包括：  
1) 发起微信内网页授权的权限  
2) 授权后获取授权用户的基本信息（权限根据应用授权作用域scope的不同而不同：scope为snsapi_base时不弹出授权页面但只能获取用户openid）；scope为snsapi_userinfo时弹出授权页面但可通过openid拿到用户昵称、性别、所在地）  
3）代替公众号使用JS SDK  
## 微信小店权限集
该权限集主要是指管理微信公众平台小店的功能，由于可供多方使用，故授权不互斥。具体包括：  
1) 微信小店所有接口权限  
2) 微信小店所有事件推送（事件将推送到创建服务时填写的公众号消息与事件接收URL）  
## 多客服权限集
该权限集主要指能否设置和获取公众账号的多客服功能开关的状态。一旦打开开关之后，客服消息将不再推送给第三方平台方，而是推送给微信多客服功能后台。此时，公众号运营者需要在mp.weixin.qq.com的多客服模块中下载多客服PC客户端来使用，与发客服消息的粉丝进行CRM沟通互动。该权限集可以授权给多个服务方，即授权不互斥，具体包括：  
1）微信多客服所有接口权限  
